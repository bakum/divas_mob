<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html >
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:pm="http://primefaces.org/mobile">

    <f:view renderKitId="PRIMEFACES_MOBILE" />

    <h:head> 
        <script src="https://maps.google.com/maps/api/js?sensor=false" type="text/javascript"></script>
        <h:outputScript library="js" name="jquery.ui.map.full.min.js"/>
        <h:outputScript library="js" name="divas.js"/>
    </h:head>
    <h:body>
        <pm:page id="list">
            <pm:header title="Divas CRM - Замеры" swatch="b">
                <p:outputLabel styleClass="ui-btn-left ui-btn-inline" value="#{sessionScope.username}" />
                <p:commandButton styleClass="ui-btn-right ui-btn-inline" value="Logout" action="#{login.doLogout()}"/>
            </pm:header>
            <pm:content>
                <h:form id="listForm">
                    <p:growl id="msgs" showDetail="true" />
                    <p:dataList var="item" value="#{orders.items}">
                        <f:facet name="header">
                            <p:commandButton immediate="true" value="Обновить замеры" action="#{orders.refresh()}"
                                             update=":list:listForm,:listOplat:listOplForm:datalist" ajax="false">

                            </p:commandButton>
                        </f:facet>                        
                        <p:commandLink update =":viewTask:editForm:editFormPanel, :listOplat:listOplForm:datalist, :uslugiList:listUslForm:listusl" action="pm:viewTask">
                            <h2>#{item.kontragId.fullname}</h2> 
                            <p>Номер заказа: #{item.num}</p> <p>Замерщик: #{item.zamerId.fullname}</p>
                            <f:setPropertyActionListener value="#{item}" target="#{orders.selected}" />
                            <f:setPropertyActionListener value="#{item}" target="#{ordersTpOplatyController.master}" />
                            <f:setPropertyActionListener value="#{item}" target="#{ordersTpUslugiController.master}" />
                        </p:commandLink>
                        <f:facet name="footer">
                            Замеры
                        </f:facet>
                    </p:dataList>
                </h:form>
            </pm:content>
            <pm:footer>
                <p:outputLabel style="text-align: center;" value="BMExpert - 2014"></p:outputLabel>
            </pm:footer>
        </pm:page>

        <pm:page id="viewTask" lazy="true">
            <pm:header title="Детали замера">
                <p:button styleClass="ui-btn-left ui-btn-inline" value="Назад" icon="ui-icon-arrow-l" outcome="pm:list?transition=flip"/>                
            </pm:header>
            <pm:content>
                <h:form id="editForm" rendered="#{orders.selected != null}">
                    <p:outputPanel id="editFormPanel" >
                        <p:commandButton id="SaveBtnId" action="#{orders.update()}" update=":list:listForm" disabled="#{!orders.zamerChanged}"
                                         value="Сохранить заказ" icon="ui-icon-check" oncomplete="pm:list?transition=flip"/>    
                        <pm:field>
                            <p:outputLabel rendered="#{!orders.haveOplaty()}" style="color: red" id="statusop" value="#{orders.oplatyStatus()}" />
                            <p:outputLabel rendered="#{orders.haveOplaty()}" style="color: blue" id="statusopl" value="#{orders.oplatyStatus()}" />
                        </pm:field>
                        <pm:field>
                            <p:outputLabel for="statusId" value="Статус заказа:" />
                            <p:selectOneMenu id="statusId" value="#{orders.selected.statusId}"
                                             required="true" 
                                             requiredMessage="Статус заказа обязателен для заполнения!" disabled="#{!orders.haveOplaty()}">
                                <f:selectItems value="#{orderStatusController.itemsAvailableSelectOne}"
                                               var="statusIdItem" itemLabel="#{statusIdItem.fullname}"
                                               itemValue="#{statusIdItem}"/>
                                <p:ajax update="SaveBtnId"/>
                            </p:selectOneMenu>
                        </pm:field>
                        <pm:field>
                            <p:outputLabel for="number" value="Номер заказа:" />
                            <p:outputLabel id="number" value="#{orders.selected.num}"/>
                        </pm:field>
                        <pm:field>
                            <p:outputLabel for="dat" value="Дата заказа:" />
                            <p:outputLabel id="dat" value="#{orders.selected.dat}">
                                <f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss" />
                            </p:outputLabel>
                        </pm:field>
                        <pm:field>
                            <p:outputLabel for="name" value="Клиент:" />
                            <p:outputLabel id="name" value="#{orders.selected.kontragId.fullname}"/>
                        </pm:field>
                        <p:spacer></p:spacer>
                        <p:dataList var="contact" value="#{orders.selected.kontragId.contactDetailsCollection}">

                            <p:commandLink update =":viewContact:editconForm,:map:mapForm:coordstr" action="pm:viewContact?transition=pop">
                                <p:outputLabel style="font-weight: bold;" value="#{contact.phone}"/>
                                <p:outputLabel style="font-size: 0.75em;" value="#{contact.adress}" rendered="#{!empty contact.adress}"/>
                                <f:setPropertyActionListener value="#{contact}" target="#{contactDetailsController.selected}" />

                                <f:setPropertyActionListener  value="selected" target="#{contactDetailsController.selectedAdressCoordinates}"/>
                            </p:commandLink>
                        </p:dataList>
                        <p:spacer></p:spacer>
                        <pm:field>
                            <p:outputLabel for="comments" value="Комментарий:" />
                            <p:inputTextarea id="comments" disabled="true" value="#{orders.selected.discription}"/>
                        </pm:field>


                    </p:outputPanel>

                </h:form>
                <p:button value="Перечень работ" icon="ui-icon-check" outcome="pm:uslugiList"/>
                <p:button value="Оплаты" icon="ui-icon-check" outcome="pm:listOplat"/>
            </pm:content>
            <pm:footer>
                <p:outputLabel style="text-align: center" value="BMExpert - 2014"></p:outputLabel>
            </pm:footer>
        </pm:page>

        <pm:page id="viewContact" lazy="true">
            <pm:header title="Контакт">
                <p:button styleClass="ui-btn-left ui-btn-inline" value="Назад" icon="ui-icon-arrow-l" outcome="pm:viewTask?transition=flip"/>
                <p:button styleClass="ui-btn-right ui-btn-inline" value="Домой" icon="ui-icon-arrow-r" outcome="pm:list?transition=flip"/>
            </pm:header>
            <pm:content>
                <h:form id="editconForm">
                    <p:growl id="savecontmsg" showDetail="true" />
                    <pm:field>
                        <p:outputLabel for="kname" value="Клиент:" />
                        <p:outputLabel id="kname" value="#{contactDetailsController.selected.kontragId.fullname}"/>
                    </pm:field>
                    <pm:field>
                        <p:outputLabel for="phone" value="Телефон:" />
                        <p:inputText id="phone" value="#{contactDetailsController.selected.phone}"/>
                    </pm:field>
                    <pm:field>
                        <p:outputLabel for="adress" value="Адрес:" />
                        <p:inputTextarea id="adress" value="#{contactDetailsController.selected.adress}"/>
                    </pm:field>
                    <pm:field>
                        <p:outputLabel for="email" value="E-Mail:" />
                        <p:inputText id="email" value="#{contactDetailsController.selected.email}" type="email"/>
                    </pm:field>
                    <p:panelGrid columns="2">
                        <p:commandButton value="Сохранить" update=":viewTask:editForm:editFormPanel" action="#{contactDetailsController.update()}"
                                         icon="ui-icon-check"/>
                        <p:button value="Отменить" outcome="pm:viewTask?transition=flip" icon="ui-icon-check"/>

                    </p:panelGrid>
                    <p:commandButton update=":map:mapForm:coordstr" value="Найти" onclick="handleViewChange('map')" action="pm:map?transition=flip" icon="ui-icon-check">

                    </p:commandButton>                    
                </h:form>
            </pm:content>
        </pm:page>

        <pm:page id="map">            
            <pm:header title="Карта">
                <p:button onclick="resetMap()" styleClass="ui-btn-left ui-btn-inline" value="Назад" icon="ui-icon-arrow-l" outcome="pm:viewContact?transition=flip"/>
                <p:button onclick="resetMap()" styleClass="ui-btn-right ui-btn-inline" value="Домой" icon="ui-icon-arrow-r" outcome="pm:list?transition=flip"/>
            </pm:header>
            <pm:content>

                <h:form id="mapForm">
                    <h:inputHidden id="coordstr" value="#{contactDetailsController.selectedAdressCoordinates}"/>

                    <p:gmap id="gmap" center="0,0" zoom="15" type="ROADMAP"   
                            style="width:100%;height:400px" /> 
                </h:form>
            </pm:content> 
            <pm:footer>
                <p:button value="Обновить" onclick="refreshMap()"/>
            </pm:footer>
        </pm:page>

        <pm:page id="listOplat">
            <pm:header title="Оплаты">
                <p:button styleClass="ui-btn-left ui-btn-inline" value="Назад" icon="ui-icon-arrow-l" outcome="pm:viewTask?transition=flip"/>
                <p:button styleClass="ui-btn-right ui-btn-inline" value="Домой" icon="ui-icon-arrow-r" outcome="pm:list?transition=flip"/>
            </pm:header>
            <pm:content>
                <p:outputPanel>

                    <h:form id="listOplForm">
                        <p:growl id="msgsopl" showDetail="true" />

                        <p:dataList id="datalist" var="oplitem" value="#{orders.selected.ordersTpOplatyCollection}">
                            <f:facet name="header"> 
                                <p:outputLabel style="text-align: center; font-weight: bold;" value="#{orders.selected.kontragId.fullname}"/>


                                <p:commandButton value="Добавить оплату" icon="ui-icon-plus" 
                                                 update =":viewOplata:viewOplForm" action="pm:viewOplata?transition=pop"
                                                 actionListener="#{ordersTpOplatyController.prepareCreate}">
                                </p:commandButton>
                            </f:facet>    
                            <p:commandLink update =":editOplata:editOplForm" action="pm:editOplata?transition=pop">
                                <p:outputLabel style="font-weight: bold;" value="#{oplitem.sum} грн"/>
                                <p:outputLabel style="font-style: italic; font-size: 0.75em;" value="#{oplitem.dat}">
                                    <f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss" />
                                </p:outputLabel>
                                <f:setPropertyActionListener value="#{oplitem}" target="#{ordersTpOplatyController.selected}" />

                            </p:commandLink>
                            <f:facet name="footer">
                                Оплаты
                            </f:facet>    
                        </p:dataList>
                    </h:form>
                </p:outputPanel>
            </pm:content>
            <pm:footer>
                <p:outputLabel style="text-align: center;" value="BMExpert - 2014"></p:outputLabel>
            </pm:footer>
        </pm:page>

        <pm:page id="viewOplata" lazy="true">
            <pm:header title="Новая оплата">
                <p:button styleClass="ui-btn-left ui-btn-inline" value="Назад" icon="ui-icon-arrow-l" outcome="pm:listOplat?transition=flip"/>
                <p:button styleClass="ui-btn-right ui-btn-inline" value="Домой" icon="ui-icon-arrow-r" outcome="pm:list?transition=flip"/>
            </pm:header>
            <pm:content>
                <h:form id="viewOplForm" rendered="#{ordersTpOplatyController.selected != null}">
                    <p:growl id="msgsopl" showDetail="true" />
                    <pm:field> 
                        <p:outputLabel style="text-align: center; font-weight: bold;" value="#{ordersTpOplatyController.master.kontragId.fullname}"/>

                    </pm:field>   
                    <pm:field rendered="false">
                        <p:outputLabel for="idopl" value="Ссылка" />
                        <p:inputText id="idopl" value="#{ordersTpOplatyController.selected.id}"/>
                    </pm:field>
                    <pm:field rendered="false">
                        <p:outputLabel for="orderidopl" value="Ссылка на заказ" />
                        <p:inputText id="orderidopl" value="#{ordersTpOplatyController.selected.orderId}"/>
                    </pm:field>
                    <pm:field>
                        <p:outputLabel for="datopl" value="Дата:" />                        
                        <p:calendar required="true" id="datopl" value="#{ordersTpOplatyController.selected.dat}">
                            <f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss" />
                        </p:calendar>
                    </pm:field>
                    <pm:field>
                        <p:outputLabel for="sumopl" value="Сумма:" />                        
                        <p:inputText required="true" id="sumopl" value="#{ordersTpOplatyController.selected.sum}" type="number"/>
                    </pm:field>
                    <pm:field>
                        <p:outputLabel for="useropl" value="Оплату принял:" />
                        <p:selectOneMenu id="useropl" value="#{ordersTpOplatyController.selected.userId}"
                                         required="true" 
                                         requiredMessage="Пользователь обязателен для заполнения!" disabled="true">
                            <f:selectItems value="#{usersController.itemsAvailableSelectOne}"
                                           var="userIdItem" itemLabel="#{userIdItem}"
                                           itemValue="#{userIdItem}"/>
                        </p:selectOneMenu>
                    </pm:field>
                    <p:panelGrid columns="2">
                        <p:commandButton value="Сохранить" update=":listOplat:listOplForm,msgsopl" action="#{ordersTpOplatyController.create()}"
                                         oncomplete="pm:listOplat?transition=flip" icon="ui-icon-check"/>
                        <p:button value="Отменить" outcome="pm:listOplat?transition=flip" icon="ui-icon-check"/>
                    </p:panelGrid>
                </h:form>
            </pm:content>
        </pm:page>

        <pm:page id="editOplata" lazy="true">
            <pm:header title="Текущая оплата">
                <p:button styleClass="ui-btn-left ui-btn-inline" value="Назад" icon="ui-icon-arrow-l" outcome="pm:listOplat?transition=flip"/>
                <p:button styleClass="ui-btn-right ui-btn-inline" value="Домой" icon="ui-icon-arrow-r" outcome="pm:list?transition=flip"/>
            </pm:header>
            <pm:content>
                <h:form id="editOplForm" rendered="#{ordersTpOplatyController.selected != null}">
                    <p:growl id="msgsopl" showDetail="true" />
                    <pm:field> 
                        <p:outputLabel style="text-align: center; font-weight: bold;" value="#{ordersTpOplatyController.master.kontragId.fullname}"/>
                    </pm:field> 
                    <pm:field rendered="false">
                        <p:outputLabel for="idopl" value="Ссылка" />
                        <p:inputText id="idopl" value="#{ordersTpOplatyController.selected.id}"/>
                    </pm:field>
                    <pm:field rendered="false">
                        <p:outputLabel for="orderidopl" value="Ссылка на заказ" />
                        <p:inputText id="orderidopl" value="#{ordersTpOplatyController.selected.orderId}"/>
                    </pm:field>
                    <pm:field>
                        <p:outputLabel for="datopl" value="Дата:" />                        
                        <p:calendar id="datopl" value="#{ordersTpOplatyController.selected.dat}">
                            <f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss" />
                        </p:calendar>
                    </pm:field>
                    <pm:field>
                        <p:outputLabel for="sumopl" value="Сумма:" />                        
                        <p:inputText id="sumopl" value="#{ordersTpOplatyController.selected.sum}" type="number"/>
                    </pm:field>
                    <pm:field>
                        <p:outputLabel for="useropl" value="Оплату принял:" />
                        <p:selectOneMenu id="useropl" value="#{ordersTpOplatyController.selected.userId}"
                                         required="true"
                                         requiredMessage="Пользователь обязателен для заполнения!" disabled="true">
                            <f:selectItems value="#{usersController.itemsAvailableSelectOne}"
                                           var="userIdItem" itemLabel="#{userIdItem}"
                                           itemValue="#{userIdItem}"/>
                        </p:selectOneMenu>
                    </pm:field>
                    <p:panelGrid columns="2">
                        <p:commandButton value="Сохранить" update=":listOplat:listOplForm,msgsopl" action="#{ordersTpOplatyController.update()}"
                                         oncomplete="pm:listOplat?transition=flip" icon="ui-icon-check"/>

                        <p:button value="Отменить" outcome="pm:listOplat?transition=flip" icon="ui-icon-check"/>
                    </p:panelGrid>
                </h:form>
            </pm:content>
        </pm:page>

        <pm:page id="uslugiList" lazy="true">
            <pm:header title="Работы">
                <p:button styleClass="ui-btn-left ui-btn-inline" value="Назад" icon="ui-icon-arrow-l" outcome="pm:viewTask?transition=flip"/>
                <p:button styleClass="ui-btn-right ui-btn-inline" value="Домой" icon="ui-icon-arrow-r" outcome="pm:list?transition=flip"/>
            </pm:header>
            <pm:content>
                <p:outputPanel>

                    <h:form id="listUslForm" rendered="#{orders.selected != null}">
                        <p:growl id="msgsusl" showDetail="false" />

                        <p:dataList id="listusl" var="uslitem" value="#{orders.selected.ordersTpUslugiCollection}">
                            <f:facet name="header"> 
                                <p:outputLabel style="text-align: center; font-weight: bold;" value="#{orders.selected.kontragId.fullname}"/>


                                <p:commandButton value="Добавить работу" icon="ui-icon-plus" 
                                                 update =":uslugiList:listUslForm"
                                                 actionListener="#{ordersTpUslugiController.prepareCreate}">
                                </p:commandButton>
                            </f:facet>    

                            <f:facet name="footer">
                                <p:outputLabel rendered="#{!orders.haveZamer()}" style="color: red" id="statusza" value="#{orders.zamerStatus()}" />
                                <p:outputLabel rendered="#{orders.haveZamer()}" style="color: blue" id="statuszam" value="#{orders.zamerStatus()}" />
                            </f:facet>    
                        </p:dataList>
                    </h:form>
                </p:outputPanel>

            </pm:content>
        </pm:page>
    </h:body>

</html>

